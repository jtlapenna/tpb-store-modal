name: Deploy with LFTP (Elementor Cloud)

on:
  push:
    branches: [ modal-clean-rebuild ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Setup LFTP
      run: |
        sudo apt-get update
        sudo apt-get install -y lftp
        
    - name: Deploy with LFTP
      env:
        HOST: sftp.elementor.cloud
        PORT: 32022
        USERNAME: dcPiEKDb
        PASSWORD: ivqWvPYFk2eDeKER
      run: |
        echo "ðŸš€ Starting LFTP deployment..."
        
        # Create lftp script with proper SFTP authentication
        cat > deploy.lftp << 'EOF'
        set sftp:auto-confirm yes
        set net:timeout 30
        set net:reconnect-interval-base 5
        set net:max-retries 3
        
        # Connect with pure SFTP (no SSH wrapper)
        open -u $USERNAME,$PASSWORD sftp://sftp.elementor.cloud:32022
        
        # Test connection
        ls
        echo "âœ… Connection successful"
        
        # Deploy theme files
        echo "ðŸ“ Deploying theme files..."
        mirror -R --verbose wp-content/themes/hello-elementor-child-tpb/ /wp-content/themes/hello-elementor-child-tpb/
        
        # Deploy plugin files  
        echo "ðŸ”Œ Deploying plugin files..."
        mirror -R --verbose wp-content/plugins/tpb-quickview-modal/ /wp-content/plugins/tpb-quickview-modal/
        
        # Deploy MU plugin files
        echo "âš¡ Deploying MU plugin files..."
        mirror -R --verbose wp-content/mu-plugins/tpb-quickview/ /wp-content/mu-plugins/tpb-quickview/
        
        echo "âœ… Deployment complete"
        quit
        EOF
        
        # Execute lftp script with environment variables
        LFTP_PASSWORD="$PASSWORD" lftp -f deploy.lftp
        
        echo "ðŸŽ‰ LFTP deployment completed successfully!"
