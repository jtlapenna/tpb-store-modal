name: Deploy with Fresh SFTP Credentials

on:
  push:
    branches: [ modal-staging ]
    paths:
      - 'wp-content/themes/hello-elementor-child-tpb/**'
      - 'wp-content/mu-plugins/tpb-quickview/**'
      - '.github/workflows/deploy-with-fresh-credentials.yml'
  workflow_dispatch:
    inputs:
      ref:
        description: 'Commit SHA, tag, or branch to deploy'
        required: false
        default: ''

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.inputs.ref || github.ref }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build TypeScript
        run: npm run build

      - name: Install SFTP client
        run: |
          sudo apt-get update
          sudo apt-get install -y openssh-client

      - name: Use Provided SFTP Credentials
        id: get-fresh-creds
        run: |
          echo "ğŸ” Using provided SFTP credentials..."
          
          # Use the credentials provided by the user
          HOST="sftp.elementor.cloud"
          PORT="32022"
          USERNAME="PLrT6LL0"
          PASSWORD="gUWnMkkV7wyQka90"
          
          echo "host=$HOST" >> $GITHUB_OUTPUT
          echo "port=$PORT" >> $GITHUB_OUTPUT
          echo "username=$USERNAME" >> $GITHUB_OUTPUT
          echo "password=$PASSWORD" >> $GITHUB_OUTPUT
          echo "credentials_found=true" >> $GITHUB_OUTPUT
          
          echo "ğŸŒ Host: $HOST"
          echo "ğŸ”Œ Port: $PORT"
          echo "ğŸ‘¤ Username: $USERNAME"
          echo "ğŸ”‘ Password: ***"

      - name: Test SFTP Connection
        if: steps.get-fresh-creds.outputs.credentials_found == 'true'
        run: |
          echo "ğŸ§ª Testing SFTP connection with fresh credentials..."
          
          # Test the connection
          timeout 30 sftp -P "${{ steps.get-fresh-creds.outputs.port }}" \
            -o ConnectTimeout=10 \
            -o StrictHostKeyChecking=no \
            -o BatchMode=yes \
            "${{ steps.get-fresh-creds.outputs.username }}@${{ steps.get-fresh-creds.outputs.host }}" <<< "exit"
          
          if [ $? -eq 0 ]; then
            echo "âœ… SFTP connection test successful!"
          else
            echo "âŒ SFTP connection test failed"
            exit 1
          fi

      - name: Deploy Theme Files with Fresh Credentials
        if: steps.get-fresh-creds.outputs.credentials_found == 'true'
        uses: wlixcc/SFTP-Deploy-Action@v1.2.4
        with:
          server: ${{ steps.get-fresh-creds.outputs.host }}
          port: ${{ steps.get-fresh-creds.outputs.port }}
          username: ${{ steps.get-fresh-creds.outputs.username }}
          password: ${{ steps.get-fresh-creds.outputs.password }}
          sftp_only: true
          local_path: 'wp-content/themes/hello-elementor-child-tpb/*'
          remote_path: '/html/wp-content/themes/hello-elementor-child-tpb/'
          delete_remote_files: false

      - name: Deploy MU-Plugin Files with Fresh Credentials
        if: steps.get-fresh-creds.outputs.credentials_found == 'true'
        uses: wlixcc/SFTP-Deploy-Action@v1.2.4
        with:
          server: ${{ steps.get-fresh-creds.outputs.host }}
          port: ${{ steps.get-fresh-creds.outputs.port }}
          username: ${{ steps.get-fresh-creds.outputs.username }}
          password: ${{ steps.get-fresh-creds.outputs.password }}
          sftp_only: true
          local_path: 'wp-content/mu-plugins/tpb-quickview'
          remote_path: '/html/wp-content/mu-plugins/'
          delete_remote_files: false

      - name: Flush Caches
        if: steps.get-fresh-creds.outputs.credentials_found == 'true'
        run: |
          echo "ğŸ”„ Flushing caches..."
          curl -fsS "${{ secrets.SITE_URL }}/?tpb_deploy_flush=${{ secrets.DEPLOY_TOKEN }}" || true

      - name: Cleanup Credentials
        if: always()
        run: |
          echo "ğŸ§¹ Cleaning up credential files..."
          rm -f fresh-credentials.json
          echo "âœ… Cleanup complete"

