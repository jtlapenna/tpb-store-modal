name: Deploy with Google Auth SFTP Credentials

on:
  push:
    branches: [ main ]
    paths:
      - 'wp-content/themes/hello-elementor-child-tpb/**'
      - 'wp-content/mu-plugins/tpb-quickview/**'
      - '.github/workflows/deploy-with-google-auth.yml'
  workflow_dispatch:
    inputs:
      ref:
        description: 'Commit SHA, tag, or branch to deploy'
        required: false
        default: ''

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.inputs.ref || github.ref }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build TypeScript
        run: npm run build

      - name: Install SFTP client
        run: |
          sudo apt-get update
          sudo apt-get install -y openssh-client

      - name: Get Fresh SFTP Credentials via Google Auth
        id: get-fresh-creds
        run: |
          echo "ðŸ” Retrieving fresh SFTP credentials from Elementor Cloud via Google Auth..."
          
          # Set environment variables for credential retrieval
          export ELEMENTOR_GOOGLE_EMAIL="${{ secrets.ELEMENTOR_GOOGLE_EMAIL }}"
          export ELEMENTOR_GOOGLE_PASSWORD="${{ secrets.ELEMENTOR_GOOGLE_PASSWORD }}"
          export ELEMENTOR_SITE_URL="${{ secrets.ELEMENTOR_SITE_URL }}"
          export OUTPUT_FILE="fresh-credentials.json"
          
          # Run the Google Auth credential retrieval script
          node scripts/get-elementor-sftp-credentials-google-auth.js
          
          # Check if credentials were retrieved successfully
          if [ -f "fresh-credentials.json" ]; then
            echo "âœ… Fresh credentials retrieved successfully via Google Auth"
            
            # Extract credentials from JSON file
            HOST=$(node -p "require('./fresh-credentials.json').host")
            PORT=$(node -p "require('./fresh-credentials.json').port")
            USERNAME=$(node -p "require('./fresh-credentials.json').username")
            PASSWORD=$(node -p "require('./fresh-credentials.json').password")
            
            echo "host=$HOST" >> $GITHUB_OUTPUT
            echo "port=$PORT" >> $GITHUB_OUTPUT
            echo "username=$USERNAME" >> $GITHUB_OUTPUT
            echo "password=$PASSWORD" >> $GITHUB_OUTPUT
            echo "credentials_found=true" >> $GITHUB_OUTPUT
            
            echo "ðŸŒ Host: $HOST"
            echo "ðŸ”Œ Port: $PORT"
            echo "ðŸ‘¤ Username: $USERNAME"
            echo "ðŸ”‘ Password: ***"
          else
            echo "âŒ Failed to retrieve fresh credentials via Google Auth"
            echo "credentials_found=false" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Test SFTP Connection
        if: steps.get-fresh-creds.outputs.credentials_found == 'true'
        run: |
          echo "ðŸ§ª Testing SFTP connection with fresh credentials..."
          
          # Test the connection
          timeout 30 sftp -P "${{ steps.get-fresh-creds.outputs.port }}" \
            -o ConnectTimeout=10 \
            -o StrictHostKeyChecking=no \
            -o BatchMode=yes \
            "${{ steps.get-fresh-creds.outputs.username }}@${{ steps.get-fresh-creds.outputs.host }}" <<< "exit"
          
          if [ $? -eq 0 ]; then
            echo "âœ… SFTP connection test successful!"
          else
            echo "âŒ SFTP connection test failed"
            exit 1
          fi

      - name: Deploy Theme Files with Fresh Credentials
        if: steps.get-fresh-creds.outputs.credentials_found == 'true'
        uses: wlixcc/SFTP-Deploy-Action@v1.2.4
        with:
          server: ${{ steps.get-fresh-creds.outputs.host }}
          port: ${{ steps.get-fresh-creds.outputs.port }}
          username: ${{ steps.get-fresh-creds.outputs.username }}
          password: ${{ steps.get-fresh-creds.outputs.password }}
          sftp_only: true
          local_path: 'wp-content/themes/hello-elementor-child-tpb/*'
          remote_path: '/html/wp-content/themes/hello-elementor-child-tpb/'
          delete_remote_files: false

      - name: Deploy MU-Plugin Files with Fresh Credentials
        if: steps.get-fresh-creds.outputs.credentials_found == 'true'
        uses: wlixcc/SFTP-Deploy-Action@v1.2.4
        with:
          server: ${{ steps.get-fresh-creds.outputs.host }}
          port: ${{ steps.get-fresh-creds.outputs.port }}
          username: ${{ steps.get-fresh-creds.outputs.username }}
          password: ${{ steps.get-fresh-creds.outputs.password }}
          sftp_only: true
          local_path: 'wp-content/mu-plugins/tpb-quickview'
          remote_path: '/html/wp-content/mu-plugins/'
          delete_remote_files: false

      - name: Flush Caches
        if: steps.get-fresh-creds.outputs.credentials_found == 'true'
        run: |
          echo "ðŸ”„ Flushing caches..."
          curl -fsS "${{ secrets.SITE_URL }}/?tpb_deploy_flush=${{ secrets.DEPLOY_TOKEN }}" || true

      - name: Cleanup Credentials
        if: always()
        run: |
          echo "ðŸ§¹ Cleaning up credential files..."
          rm -f fresh-credentials.json
          echo "âœ… Cleanup complete"
